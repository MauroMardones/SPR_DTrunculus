---
title: "Supporting Information 1"
subtitle: "CHANGES OF POPULATION STATUS AND REPRODUCTIVE OUTPUT from both empirical and model based perspective.: CONSIDERATIONS FOR THE CONSERVATION OF NATURAL POPULATIONS OF DONAX TRUNCULUS (L. 1758)"
#author: "Mardones, M; Jarvis Mason, E.T.;  Santa Cruz, F.; Watters, G.; CÃ¡rdenas, C.A"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: LBSPR_Dtrunculus.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
output:
  bookdown::html_document2:
    fig_caption: yes
    keep_md: true
    toc: true
    toc_deep: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    code-tools: true
    number_sections: false
editor_options: 
  markdown: 
    wrap: 72
---

\pagebreak

```{r setup1, echo=FALSE}
set.seed(999)
rm(list = ls())
knitr::opts_chunk$set(echo=TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      fig.pos = "H",
                      dev = 'jpeg',
                      dpi = 300,
                      tidy = TRUE,
                      tidy.opts = list(width.cutoff = 60)
)
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```



```{r message=FALSE}
## Installing the Package
#The LBSPR package is now available on CRAN:
#install.packages("LBSPR")
#install.packages("devtools")
#devtools::install_github("AdrianHordyk/LBSPR")
###load the package
library(LBSPR)
library(devtools)#to install_github
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(ggpubr)
library(kableExtra)
library(hrbrthemes)
library(ggthemes)
library(tidyverse)
```

```{r echo=FALSE, warning=FALSE}
thememau <- theme(axis.text.y = element_blank(),
                  axis.ticks.y = element_blank(),
                  axis.ticks.x=element_blank(),
                  panel.background = element_blank(),
                  panel.border = element_rect(fill = NA, size = 1),
                  strip.background = element_rect(fill = "white", 
                                                  color = "white", 
                                                  size = 1),
                  text = element_text(size = 14),
                  panel.grid.major = element_line(colour = "white", 
                                                  size = 0.1),
                  panel.grid.minor = element_line(colour = "white", 
                                                  size = 0.1))
```

\pagebreak

# CONTEXT




# METHODOLOGY


## LBSPR Modeling

### Biological and fishery parameters wedge clam

```{r}
#Create a new LB_pars Object
#To create a new LB_pars object you use the new function:
MyPars <- new("LB_pars")
MyPars23 <- new("LB_pars")

#You can see the elements or slots of the LB_pars object using the
#slotNames function:
#slotNames(MyPars)
```

The model needs specifications related to both biological and fishery parameters according to species evaluated. In a descriptive way, the main parameter sets are described as follows;

**Biology**

-   von Bertalanffy asymptotic length `Linf`
-   M/K ratio (natural mortality)divided by von Bertalanffy K coefficient) `MK`
-   Length at 50% maturity (`L50`)
-   Length at 95% maturity (`L95`)

**Fishery**

-   Length at 50% selectivity (`SL50`)
-   Length at 95% selectivity (`SL95`)
-   Biological Reference Point (BRP). F/M ratio (`FM`) or Spawning Potential Ratio (`SPR`). If you specify both, the F/M value will be ignored.

**Size Classes**

-Width of the length classes (`BinWidth`)

```{r}
#MyPars <- new("LB_pars")
## A blank LB_pars object created
## Default values have been set for some parameters
MyPars@Species <- "Donax trunculus"
MyPars@Linf <- 49 
MyPars@L50 <- 10.4
MyPars@L95 <- 25 # verrificar bibliografia
MyPars@MK <- 0.99/0.48


#Explotation
#MyPars@SL50 <- 25#numeric() #1
#MyPars@SL95 <- 30#numeric() #27
MyPars@SPR <- 0.40 #numeric()# ###cambia el numero 0.4 a en blanco
MyPars@BinWidth <- 1
#MyPars@FM <- 1

MyPars@Walpha <- 0.0001
MyPars@Wbeta <- 3.0637 #r2 = 0.9651

MyPars@BinWidth <-1
MyPars@BinMax <- 50
MyPars@BinMin <- 0
MyPars@L_units <- "mm"
```

otro Escenario 23 mm selectivity

```{r}

## A blank LB_pars object created
## Default values have been set for some parameters
MyPars23@Species <- "Donax trunculus 2"
MyPars23@Linf <- 49 
MyPars23@L50 <- 10.4
MyPars23@L95 <- 25 # verrificar bibliografia
MyPars23@MK <- 0.99/0.48


#Explotation
#MyPars23@SL50 <- 23#numeric() #1
#MyPars23@SL95 <- 30#numeric() #27
MyPars23@SPR <- 0.40 #numeric()# ###cambia el numero 0.4 a en blanco
MyPars23@BinWidth <- 1
#MyPars@FM <- 1

MyPars23@Walpha <- 0.0001
MyPars23@Wbeta <- 3.0637 #r2 = 0.9651

MyPars23@BinWidth <-1
MyPars23@BinMax <- 50
MyPars23@BinMin <- 0
MyPars23@L_units <- "mm"
```


```{r table_par}
tablepar <-data.frame(Value=c(MyPars@Linf,
                       MyPars@L50 ,
                       MyPars@L95 ,
                       MyPars@MK ,
                       MyPars@SL50 ,
                       MyPars@SL95 ,
                       MyPars@SPR ,
                       MyPars@Walpha ,
                       MyPars@Wbeta ,
                       MyPars@BinMax,
                       MyPars@BinMin ,
                       MyPars@L_units),
                      Descrption=c("VB asymptotic length",
                                   "Maturity 50%",
                                   "Maturity 95%",
                                   "M/K Ratio",
                                   "Selectivity 50%",
                                   "Seletivity 95%",
                                   "SPR",
                                   "a (Length-Weight Relation)",
                                   "b (Length-Weight Relation)",
                                   "Bin Min",
                                   "Bin Max",
                                   "Units"))
```

These parameters were taken from previous works about krill life history and fishery [@Thanassekos2014; @Maschette2020], which are described in Table \@ref(tab:Table1).

```{r Table1}
kbl(tablepar, 
    longtable = F, 
    booktabs = T, 
    caption = "Krill biological and fishery parameters") %>% 
   kable_styling(latex_options = c("striped", 
                                   "hold_position"),
                 html_font = "arial") 
```


### Model Estimation LBSPR

Recent work has shown that under equilibrium conditions (that is, constant F and no recruitment variability) and assuming the von Bertalanffy growth equation, constant natural mortality for all ages, and logistic or jack-knife selectivity, standardization of the composition of lengths of two populations with the same ratio of natural mortality to growth rate (*M/k*) and the same ratio of mortality by fishing to natural mortality (*F/M*) will be identical [@Hordyk2016]. Extension of this model to incorporate length-at-age variability and logistic selectivity confirms that, at equilibrium, the composition of the predicted duration of catch of an exploited population is primarily determined by the ratios of M/k and F/M. The analytical models developed in @Hordyk2014 suggest that with knowledge of the asymptotic von Bertalanffy length $L_{\infty}$ and the coefficient of variation in $CVL_{\infty}$, the ratio of total mortality to the von Bertalanffy growth coefficient (*Z/k*) for a given population can be estimated from a representative sample of the size structure of the catch. If *M/k* (or parameters) is also known, then the results of @Hordyk2016 suggest that it is possible to estimate F/M from the composition of the catch. Often the F/M ratio has been used as a biological reference point when is 1 [@Zhou2012].

The LBSPR model requires the following parameters: an estimate of the M/k ratio, $L_{\infty}$, $CVL_{\infty}$, and knowledge of maturity by length (maturity ogive), both set parameters know in krill. This model uses data on composition by catch sizes to estimate intrinsic productivity or Spawning Potential Ratio (SPR). This concept was extracted from @Goodyear1993, where the ratio of lifetime average egg production per recruit (EPR) was calculated for fished and no fished (virgin condition) resources. An algorithm route for the calculation of the SPR is the following;

$${SPR}=\frac{EPR_{fished}}{EPR_{nofished}}$$ where;

$$
EPR_{fished} =
\sum_{a}
\begin{cases}
 E_{a},  a = 0  \\
 e^{-Z_{{a-1}}a} {E_a}, 0 < a  < a_\le{max}
 \end{cases}       
$$ 

where $Z_a$ = $M+F_a$, and $E$ is egg production at age assumed to be proportional to weight;

$$E_a \in  Mat_a W_a$$ on the other hand, the calculation of the reproductive potential is the same as that of those captured without F; $$
EPR_{nofished} =
\sum_{a}
 E_ae^{-M_a}
$$ Assuming that egg production is proportional to the size of mature fish, relative fecundity-at-size is given by;

$$
Fec_{L,g} = Mat_{L,g} L^b
$$ where b is value of the exponent to reflect differente size fecunditity relationship and g is the fraction of recruits to group.

Assuming reasonable estimates of the M/K ratio, $L_{\infty}$ (or $CVL_{\infty}$), size-at-maturity, the parameters F/M, $SL_{50}$, and $SL_{95}$ can be estimated from a representative sample of the length structure of the catch by minimizing the following multinomial negative loglikelihood function (NLL):

$$
NLL =
argmin\sum_{i}
 O_i ln\frac{\hat{P}_i}{\hat{O}_i}
$$

where $O_i$ and $\hat{O}_i$ are the observed number and proportion in length class i, respectively, and $\hat{P}_i$ is the model estimate of the probability in length class i [@Hordyk2016].


The LBSPR package can be used to generate the expected size composition, the SPR, and relative yield for a given set of biological and exploitation pattern parameters. The output of the `LBSPRsim` function is an object of class `LB_obj`. This is another LBSPR object, and contains all of the information from the `LB_pars` object and the output of the `LBSPRsim` function.

It is important to note that the F/M ratio reported in the LBSPR model refers to the apical F over the adult natural mortality rate. That is, the value for fishing mortality refers to the highest level of F experienced by any single size class [@Hordyk2014]. If the selectivity pattern excludes all but the largest individuals from being exploited, it is possible to have a very high F/M ratio in a sustainable fishery (high SPR) and visceverse. Note that only the life history parameters need to be specified for the estimation model. The exploitation parameters will be estimated [@Hordyk2014].

Two objects are required to fit the LBSPR model to length data: life-history parameters (`LB_pars`) described previously (2.4. section) and size compositions (`LB_lengths`), which contains the length frequency data. We provide a set of global size data and also by strata, with which we will be able to identify the spatial differences of the potential.

```{r}
MyLengths <- new("LB_lengths")
slotNames(MyLengths)


MyLengths23 <- new("LB_lengths")
slotNames(MyLengths23)

```

However, it is probably easier to create the `LB_lengths` object by directly reading in a `.csv`. A length frequency data of krill set with multiple years (2001-2020) by strata in 48.1 Subarea.

```{r message=F, warning=FALSE}
Lendt <- new("LB_lengths", 
             LB_pars=MyPars, 
             file=("data/LDF_Dtrunculus.csv"), 
             dataType="freq",
             sep=",",
             header=T)

Lendt23 <- new("LB_lengths", 
             LB_pars=MyPars23, 
             file=("data/LDF_Dtrunculus.csv"), 
             dataType="freq",
             sep=",",
             header=T)
```


### Fit the Model by strata

The LBSPR model is fitted by strata using the `LBSPRfit` function. 

```{r message=FALSE}
fitdt <- LBSPRfit(MyPars, Lendt)
fitdt23 <- LBSPRfit(MyPars23, Lendt23)
```




\newpage

# RESULTS

## Model Perfomance

The results demonstrate good fits of the size structure distribution model for krill across the strata. The model accurately captures the distribution patterns of size classes, indicating its effectiveness in characterizing the population structure. The model successfully captures the variations in size distribution, reflecting the natural variability in krill populations across different strata. These findings suggest that the model can be utilized as a valuable tool for understanding and predicting size structure dynamics in krill populations (Figure \@ref(fig:Figure5)).

```{r Figure5, fig.cap="Fit of the model to the data of lengths in all strata"}
dtcom1 <-plotSize(fitdt,
                  scales = "fixed",
         Title="D. trunculus")+
  thememau
dtcom1
dtcom123 <-plotSize(fitdt23,
                  scales = "fixed",
         Title="D. trunculus 23")+
  thememau
ggarrange(dtcom1,
          dtcom123,
          ncol=2)
```


The difference between the observed accumulated size compositions for each stratum and compare it with the expected size composition at a target SPR (75% SPR). In the simulation of the structure in its virgin condition (without fishing), the red bars represent each stratum. Additionally, the overlap with the average structures observed during the years of fishery monitoring can be visualized. The SSWI Gerlache and EI strata exhibit the greatest differences from the simulated structure, possibly due to the significant contribution of juveniles in these strata. Conversely, the BS and JO strata demonstrate the closest resemblance to the simulated structure (Figure \@ref(fig:Figure6)).

```{r Figure6, fig.cap="Difference between the observed accumulated size structure for each stratum related SPR objective", fig.height=4, fig.width=8}
yr <- 5 # first year of data

dtcom <- plotTarg(MyPars, Lendt, yr=yr,
                  Cols = c(2,4),
                  size.axtex = 8,
                  title="49 Linf",
                  targtext = FALSE)+
  thememau 

dtcom23 <- plotTarg(MyPars23, Lendt23, yr=yr,
                  Cols = c(2,4),
                  size.axtex = 8,
                  title="48 Linf",
                  targtext = FALSE)+
  thememau 
ggarrange(dtcom,
          dtcom23,
          ncol = 2, common.legend = T)
```

Furthermore, ogive maturity curve specific to each stratum and year, as well as the estimated length selectivity curve, are presented in (Figure \@ref(fig:Figure7)). These curves offer crucial insights into the fishery's impact on the population and its reproductive status, providing measures of the population's vulnerability to fishing mortality. Notably, the Brainsfield stratum stands out with a lower proportion of mature individuals, suggesting a higher prevalence of juveniles. It is important to note that the same maturity parameters were applied across all strata.

```{r Figure7, fig.cap= "Maturity curves by strata", out.width="80%"}

dtmat <- plotMat(fitdt,
        useSmooth = TRUE,
        Title="49 Linf")+
  thememau 
dtmat23 <- plotMat(fitdt23,
        useSmooth = TRUE,
        Title="48 Linf")+
  thememau 
ggarrange(dtmat,
          dtmat23,
          ncol=1, common.legend = T,
          legend = "bottom")
```

## Comparing producivity between years and Stratas

The analysis of the krill population's reproductive potential across different years and strata reveals significant differences. Brainsfield and Gerlache strata exhibit a low reproductive potential below the proposed management target of 75% in the last year, with values of 0.121 and 0.085, respectively, falling even below the limit reference point. This condition arises from the concentration of a substantial number of immature individuals (juveniles) in these strata, which are being exploited by the fishery, thereby hindering their reproductive cycles from completing. On the contrary, the Elephant Island stratum demonstrates higher spawning potential ratio (SPR) levels in recent years, reaching 0.421 in 2019, which aligns closer to the management objective. This discrepancy is attributed to the spatial distribution of krill, as the Elephant Island stratum possesses a larger proportion of adult individuals compared to other strata.

```{r}
sprdt <- as.data.frame(cbind(fitdt@Years, 
                             fitdt@SPR,
                             fitdt@Vars[,4])) 
colnames(sprdt) <- c("Year","SPR", "Var")
sprdt$SPRv <- rep("BS", nrow(sprdt))


allspr <- sprdt %>%
  mutate(SD = sqrt(Var))

sprdt23 <- as.data.frame(cbind(fitdt23@Years, 
                             fitdt23@SPR,
                             fitdt23@Vars[,4])) 
colnames(sprdt23) <- c("Year","SPR", "Var")
sprdt23$SPRv <- rep("BS", nrow(sprdt23))


allspr23 <- sprdt23 %>%
  mutate(SD = sqrt(Var))

```

Figure \@ref(fig:Figure8) provides a visual representation of the SPR trends across years and strata, clearly indicating the references (yellow line = 75% SPR Objective and Red line = 20% Limit SPR).

```{r Figure8, message=FALSE, fig.cap="Krill Intrinsic Productivity (SPR) by strata and by year"}
allsprpl <- ggplot(allspr, aes(Year, SPR)) +
  geom_point(alpha = 0.8, color = "#2b8cbe", size = 2) + 
  geom_errorbar(aes(ymin = SPR - SD, ymax = SPR + SD),  
                width = 0.2,  
                alpha = 0.5) +
  geom_smooth(method = "loess",
              alpha = 0.3,
              se = TRUE,
              color = "black",
              level = 0.75) +
  geom_hline(yintercept = 0.40,
             colour = '#bd0026',
             alpha = 0.7,
             linewidth = 1) +
  scale_x_continuous(breaks = 2013:2023, limits = c(2013, 2023)) +
  scale_y_continuous(limits = c(0, 0.9), labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Year", y = "SPR (Spawning Potential Ratio)") +
  theme_few(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )

allsprpl23 <- ggplot(allspr23, aes(Year, SPR)) +
  geom_point(alpha = 0.8, color = "#74c476", size = 2) + 
  geom_errorbar(aes(ymin = SPR - SD, ymax = SPR + SD),  
                width = 0.2,  
                alpha = 0.5) +
  geom_smooth(method = "loess",
              alpha = 0.3,
              se = TRUE,
              color = "black",
              level = 0.75) +
  geom_hline(yintercept = 0.40,
             colour = '#bd0026',
             alpha = 0.7,
             linewidth = 1) +
  scale_x_continuous(breaks = 2013:2023, limits = c(2013, 2023)) +
  scale_y_continuous(limits = c(0, 0.9), labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Year", y = "SPR (Spawning Potential Ratio)") +
  theme_few(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )

# Mostrar ambos en una figura
ggarrange(allsprpl, allsprpl23, ncol = 2, labels = c("A", "B"))


```

All the estimated values of SPR and their associated variance by stratum and by year can be identified in  Table \@ref(tab:Table2).

```{r Table2}

allsprwide_reorganizado <- allsprwide %>%
  mutate(
    `BS` = ifelse(!is.na(`SPR BS`), paste0(`SPR BS`, " (", `SD BS`, ")"), NA),
    `EI` = ifelse(!is.na(`SPR EI`), paste0(`SPR EI`, " (", `SD EI`, ")"), NA),
    `GS` = ifelse(!is.na(`SPR GS`), paste0(`SPR GS`, " (", `SD GS`, ")"), NA),
    `JOIN` = ifelse(!is.na(`SPR JOIN`), paste0(`SPR JOIN`, " (", `SD JOIN`, ")"), NA),
    `SSWI` = ifelse(!is.na(`SPR SSWI`), paste0(`SPR SSWI`, " (", `SD SSWI`, ")"), NA)
  ) %>%
  select(Year, `BS`, `EI`, `GS`, `JOIN`, `SSWI`) %>% 
  arrange(Year)

# guardo
#write_csv(allsprwide_reorganizado, "SPR_Total.csv")

kbl(allsprwide_reorganizado, 
    longtable = FALSE, 
    booktabs = TRUE, 
    caption = "Estimates of SPR by Strata (values in parentheses represent the standard deviation)") %>% 
    kable_styling(latex_options = c("scale_down", "hold_position"))

```


\newpage

## Sensitivity and perfomance analysis

The results of the methods in the reference setting are compared to the obtained under overstimation/underestimation in intrinsic productivity regarding asymptotic length von Bertalanffy $L_{\infty}$ parameter in krill. First, it was possible to identify that for all strata, the impact of low $L_{\infty}$ ranges under the base model (60 mm) overestimates the level of reproductive potential krill with values between 42% and 32% (Bransfield and Elephant Island strata respectively). Regarding higher $L_{\infty}$ settings, the model tends to underestimate the reproductive potential with values between -25% and -30% (Gerlache and Joinville strata) Figure \@ref(fig:Figure9),  Table \@ref(tab:Table3).

```{r message=FALSE}

for (i in 55:65) {
  nombre_objeto <- paste0("MyPars_", i)  # Crear un nombre Ãºnico para cada objeto modificado
  objeto_modificado <- MyPars  # Crear una copia del objeto original
  
  objeto_modificado@Linf <- i  # Modificar el valor de @Linf en cada iteraciÃ³n
  
  assign(nombre_objeto, objeto_modificado, envir = .GlobalEnv)  # Asignar el objeto modificado al nombre creado
  
  # Resto del cÃ³digo que deseas ejecutar con el objeto modificado
## A blank LB_pars object created
## Default values have been set for some parameters
      MyPars@Species <- "Euphausia superba"
      MyPars@L50 <- 34 
      MyPars@L95 <- 55 # verrificar bibliografia
      MyPars@MK <- 0.4/0.45
      
      
      #Explotation
      MyPars@SL50 <- 40#numeric() #1
      MyPars@SL95 <- 56#numeric() #27
      MyPars@SPR <- 0.75 #numeric()# ###cambia el numero 0.4 a en blanco
      MyPars@BinWidth <- 1
      #MyPars@FM <- 1
      
      MyPars@Walpha <- 1
      MyPars@Wbeta <- 3.0637 #r2 = 0.9651
      
      MyPars@BinWidth <-1
      MyPars@BinMax <- 70
      MyPars@BinMin <- 0
      MyPars@L_units <- "mm"
  
  # Imprimir el valor de @Linf despuÃ©s de cada cambio
  #print(get(nombre_objeto)@Linf)
}
```



```{r message=FALSE}
# ciclo de ajuste para BS
for (i in 55:65) {
  nombre_objeto <- paste0("MyPars_", i)  # Nombre del objeto S4 en cada iteraciÃ³n
  nombre_variable <- paste0("fitbs", i)  # Nuevo nombre para el resultado
  
  # Obtener el objeto S4 correspondiente
  objeto <- get(nombre_objeto)
  
  # Ejecutar LBSPRfit() y asignar el resultado a una nueva variable con nombre Ãºnico
  assign(nombre_variable, LBSPRfit(objeto, Lenbs), envir = .GlobalEnv)
}


# ciclo de ajuste para Gerlache
for (i in 55:65) {
  nombre_objeto <- paste0("MyPars_", i)  
  nombre_variable <- paste0("fitei", i)  
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lenei), envir = .GlobalEnv)
}

# ciclo de ajuste para Gerlache
for (i in 55:65) {
  nombre_objeto <- paste0("MyPars_", i)  
  nombre_variable <- paste0("fitgc", i)  
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lengc), envir = .GlobalEnv)
}

# ciclo de ajuste para JoinVIlle
for (i in 55:65) {
  nombre_objeto <- paste0("MyPars_", i) 
  nombre_variable <- paste0("fitjo", i)  
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lenjo), envir = .GlobalEnv)
}

# ciclo de ajuste para JSSWI
for (i in 55:65) {
  nombre_objeto <- paste0("MyPars_", i) 
  nombre_variable <- paste0("fitsswi", i) 
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lenssiw), envir = .GlobalEnv)
}
```



```{r}
#Genero lo que quiero comparar BS
valbs <- as.data.frame(cbind(fitbs55@Years,
  fitbs55@SPR,
           fitbs56@SPR,
           fitbs57@SPR,
           fitbs58@SPR,
           fitbs59@SPR,
           fitbs60@SPR,
           fitbs61@SPR,
           fitbs62@SPR,
           fitbs63@SPR,
           fitbs64@SPR,
           fitbs65@SPR))
colnames(valbs) <- c("Years", "Linf55","Linf56", "Linf57", "Linf58", 
                     "Linf59", "Linf60", 
                      "Linf61", "Linf62" , "Linf63",  "Linf64",
                     "Linf65")

valbs_largo <- pivot_longer(valbs, 
                            cols = c(2:12,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valbs_largo$SPRstra <- rep("BS", nrow(valbs_largo))

#Genero lo que quiero comparar EI
valei <- as.data.frame(cbind(fitei55@Years,
  fitei55@SPR,
           fitei56@SPR,
           fitei57@SPR,
           fitei58@SPR,
           fitei59@SPR,
           fitei60@SPR,
           fitei61@SPR,
           fitei62@SPR,
           fitei63@SPR,
           fitei64@SPR,
           fitei65@SPR))
colnames(valei) <- c("Years", "Linf55","Linf56", "Linf57", "Linf58", 
                     "Linf59", "Linf60", 
                      "Linf61", "Linf62" , "Linf63",  "Linf64",
                     "Linf65")

valei_largo <- pivot_longer(valei, 
                            cols = c(2:12,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valei_largo$SPRstra <- rep("EI", nrow(valei_largo))
#Genero lo que quiero comparar Gerlache
valgc <- as.data.frame(cbind(fitgc55@Years,
  fitgc55@SPR,
           fitgc56@SPR,
           fitgc57@SPR,
           fitgc58@SPR,
           fitgc59@SPR,
           fitgc60@SPR,
           fitgc61@SPR,
           fitgc62@SPR,
           fitgc63@SPR,
           fitgc64@SPR,
           fitgc65@SPR))
colnames(valgc) <- c("Years", "Linf55","Linf56", "Linf57", "Linf58", 
                     "Linf59", "Linf60", 
                      "Linf61", "Linf62" , "Linf63",  "Linf64",
                     "Linf65")

valgc_largo <- pivot_longer(valgc, 
                            cols = c(2:12,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valgc_largo$SPRstra <- rep("GS", nrow(valgc_largo))

#Genero lo que quiero comparar JOin
valjo <- as.data.frame(cbind(fitjo55@Years,
  fitjo55@SPR,
           fitjo56@SPR,
           fitjo57@SPR,
           fitjo58@SPR,
           fitjo59@SPR,
           fitjo60@SPR,
           fitjo61@SPR,
           fitjo62@SPR,
           fitjo63@SPR,
           fitjo64@SPR,
           fitjo65@SPR))
colnames(valjo) <- c("Years", "Linf55","Linf56", "Linf57", "Linf58", 
                     "Linf59", "Linf60", 
                      "Linf61", "Linf62" , "Linf63",  "Linf64",
                     "Linf65")

valjo_largo <- pivot_longer(valjo, 
                            cols = c(2:12,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valjo_largo$SPRstra <- rep("JOIN", nrow(valjo_largo))

#Genero lo que quiero comparar SSWI
valsswi <- as.data.frame(cbind(fitsswi55@Years,
  fitsswi55@SPR,
           fitsswi56@SPR,
           fitsswi57@SPR,
           fitsswi58@SPR,
           fitsswi59@SPR,
           fitsswi60@SPR,
           fitsswi61@SPR,
           fitsswi62@SPR,
           fitsswi63@SPR,
           fitsswi64@SPR,
           fitsswi65@SPR))
colnames(valsswi) <- c("Years", "Linf55","Linf56", "Linf57", "Linf58", 
                     "Linf59", "Linf60", 
                      "Linf61", "Linf62" , "Linf63",  "Linf64",
                     "Linf65")

valsswi_largo <- pivot_longer(valsswi, 
                            cols = c(2:12,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valsswi_largo$SPRstra <- rep("SSWI", nrow(valsswi_largo))
#agrupo
valtodo <- rbind(valsswi_largo, 
              valjo_largo,
              valbs_largo,
              valei_largo,
              valgc_largo)
```

Figure \@ref(fig:Figure9) provides a plot by strata with scenarios of L~inf~ of the SPR trends across strata (yellow line = 75% SPR Objective and Red line = 20% Limit SPR).


```{r Figure9, warning=FALSE, fig.cap="Sensitivity analysis by strata about asymptotic length VB", fig.height=3, fig.width=8}
valtodo <- valtodo %>%
  mutate(Highlight = ifelse(Parameter == "Linf60", "Highlighted", "Normal"))
sensproto <- ggplot(valtodo %>%
                      drop_na() %>%
                      filter(SPR < 0.65),
                    aes(x = SPR,
                        y = Parameter)) +
  geom_boxplot(aes(fill = ifelse(Parameter == "Linf60", "red", NA)),  
               trim = TRUE,
               color = "black",  
               position = position_dodge(0.9),
               adjust = 1/5) +
  geom_vline(xintercept = 0.75,
             colour = '#006d2c',
             alpha = 0.5,
             linetype = 2) +
  geom_vline(xintercept = 0.20,
             colour = '#bd0026',
             alpha = 0.5) +
  geom_jitter(aes(fill = ifelse(Parameter == "Linf60", "red", NA)),  
              shape = 21,  
              color = "black", 
              alpha = 0.5,  
              height = 0,
              width = 0.1) +
  facet_wrap(~SPRstra,
             ncol = 11) +
  labs(x = "SPR",
       y = "VB Parameters tested") +
  theme_minimal() +
  theme(legend.position = "none",  
        axis.text.x = element_text(angle = 90, hjust = 2),
        panel.background = element_rect(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  xlim(0, 1) +
  scale_fill_identity()  

sensproto

```


```{r message=F}

tablinf <- valtodo %>% 
  group_by(Parameter, SPRstra) %>% 
  summarise(Median = mean(SPR),
            Variance=sd(SPR)) %>% 
  pivot_wider(names_from= SPRstra, 
              values_from = c(Median, Variance),
              names_sep = " ") %>% 
  rename( "VB scenario"="Parameter") %>% 
   mutate_if(is.numeric, round, 2)



tablinf_reorganizado <- tablinf %>%
  mutate(
    `BS` = paste0(`Median BS`, " (", `Variance BS`, ")"),
    `EI` = paste0(`Median EI`, " (", `Variance EI`, ")"),
    `GS` = paste0(`Median GS`, " (", `Variance GS`, ")"),
    `JOIN` = paste0(`Median JOIN`, " (", `Variance JOIN`, ")"),
    `SSWI` = paste0(`Median SSWI`, " (", `Variance SSWI`, ")")
  ) %>%
  select(`VB scenario`, `BS`, `EI`, `GS`, `JOIN`, `SSWI`)

#write_csv(tablinf_reorganizado, "SPR_Linf.csv")
```

All the estimated values of SPR by L~inf~scenario by stratum can be identified in  Table \@ref(tab:Table4).

```{r Table4, message=F}
kbl(tablinf_reorganizado, 
    longtable = FALSE, 
    booktabs = TRUE, 
    caption = "\\label{Table3}Estimated by asymptotyc lenght (VB) scenario (values in parentheses represent the standard deviation)") %>% 
    kable_styling(latex_options = c("scale_down", "hold_position"))

```

Regarding the three growth levels of the species (high, medium, low) referred to the parameter $k$, it was possible to identify that high and medium growth types result in very low SPR (spawning potential ratio) estimates compared to slow and medium growth. In fact, with high individual growth, the model estimates that SPR levels would be very close to the target management levels (75% SPR) and far from the limit reference level of 20% (Figure \@ref(fig:Figure10),  Table \@ref(tab:Table5)).

```{r message=FALSE}

for (i in c(2,0.5,0.3)) {
  nombre_objeto <- paste0("MyPars_", i)  # Crear un nombre Ãºnico para cada objeto modificado
  objeto_modificado <- MyPars  # Crear una copia del objeto original
  
  objeto_modificado@MK <- i  # Modificar el valor de @Linf en cada iteraciÃ³n
  
  assign(nombre_objeto, objeto_modificado, envir = .GlobalEnv)  # Asignar el objeto modificado al nombre creado
  
  # Resto del cÃ³digo que deseas ejecutar con el objeto modificado
## A blank LB_pars object created
## Default values have been set for some parameters
      MyPars@Species <- "Euphausia superba"
      MyPars@L50 <- 34 
      MyPars@L95 <- 55 # verrificar bibliografia
      MyPars@Linf <- 60
      
      
      #Explotation
      MyPars@SL50 <- 40#numeric() #1
      MyPars@SL95 <- 56#numeric() #27
      MyPars@SPR <- 0.75 #numeric()# ###cambia el numero 0.4 a en blanco
      MyPars@BinWidth <- 1
      #MyPars@FM <- 1
      
      MyPars@Walpha <- 1
      MyPars@Wbeta <- 3.0637 #r2 = 0.9651
      
      MyPars@BinWidth <-1
      MyPars@BinMax <- 70
      MyPars@BinMin <- 0
      MyPars@L_units <- "mm"
  
  # Imprimir el valor de @Linf despuÃ©s de cada cambio
  #print(get(nombre_objeto)@Linf)
}
```

```{r message=FALSE}

# ciclo de ajuste para BS
for (i in c(2,0.5,0.3)) {
  nombre_objeto <- paste0("MyPars_", i)  # Nombre del objeto S4 en cada iteraciÃ³n
  nombre_variable <- paste0("fitbs", i)  # Nuevo nombre para el resultado
  
  # Obtener el objeto S4 correspondiente
  objeto <- get(nombre_objeto)
  
  # Ejecutar LBSPRfit() y asignar el resultado a una nueva variable con nombre Ãºnico
  assign(nombre_variable, LBSPRfit(objeto, Lenbs), envir = .GlobalEnv)
}


# ciclo de ajuste para Gerlache
for (i in c(2,0.5,0.3)) {
  nombre_objeto <- paste0("MyPars_", i)  
  nombre_variable <- paste0("fitei", i)  
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lenei), envir = .GlobalEnv)
}

# ciclo de ajuste para Gerlache
for (i in c(2,0.5,0.3)) {
  nombre_objeto <- paste0("MyPars_", i)  
  nombre_variable <- paste0("fitgc", i)  
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lengc), envir = .GlobalEnv)
}

# ciclo de ajuste para JoinVIlle
for (i in c(2,0.5,0.3)) {
  nombre_objeto <- paste0("MyPars_", i) 
  nombre_variable <- paste0("fitjo", i)  
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lenjo), envir = .GlobalEnv)
}

# ciclo de ajuste para JSSWI
for (i in c(2,0.5,0.3)) {
  nombre_objeto <- paste0("MyPars_", i) 
  nombre_variable <- paste0("fitsswi", i) 
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Lenssiw), envir = .GlobalEnv)
}
```


```{r}
#Genero lo que quiero comparar BS
valprobs <- as.data.frame(cbind(fitbs0.3@Years,
                                fitbs0.3@SPR,
                             fitbs0.5@SPR,
                             fitbs2@SPR))
colnames(valprobs) <- c("Years", "High","Med", "Low")

valprobs_largo <- pivot_longer(valprobs, 
                            cols = c(2:4,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valprobs_largo$SPRstra <- rep("BS", nrow(valprobs_largo))

#Genero lo que quiero comparar EI
valproei <- as.data.frame(cbind(fitei0.3@Years,
                              fitei0.3@SPR,
                             fitei0.5@SPR,
                             fitei2@SPR))
colnames(valproei) <- c("Years", "High","Med", "Low")

valproei_largo <- pivot_longer(valproei, 
                            cols = c(2:4,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valproei_largo$SPRstra <- rep("EI", nrow(valproei_largo))
#Genero lo que quiero comparar Gerlache
valprogc <- as.data.frame(cbind(fitgc0.3@Years,
                              fitgc0.3@SPR,
                             fitgc0.5@SPR,
                             fitgc2@SPR))
colnames(valprogc) <- c("Years", "High","Med", "Low")

valprogc_largo <- pivot_longer(valprogc, 
                            cols = c(2:4,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valprogc_largo$SPRstra <- rep("GS", nrow(valprogc_largo))
#Genero lo que quiero comparar JOin
valprojo <- as.data.frame(cbind(fitjo0.3@Years,
                              fitjo0.3@SPR,
                             fitjo0.5@SPR,
                             fitjo2@SPR))
colnames(valprojo) <- c("Years", "High","Med", "Low")

valprojo_largo <- pivot_longer(valprojo, 
                            cols = c(2:4,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valprojo_largo$SPRstra <- rep("JOIN", nrow(valprojo_largo))

#Genero lo que quiero comparar SSWI
valprosswi <- as.data.frame(cbind(fitsswi0.3@Years,
                              fitsswi0.3@SPR,
                             fitsswi0.5@SPR,
                             fitsswi2@SPR))
colnames(valprosswi) <- c("Years", "High","Med", "Low")

valprosswi_largo <- pivot_longer(valprosswi, 
                            cols = c(2:4,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valprosswi_largo$SPRstra <- rep("SSWI", nrow(valprosswi_largo))
#agrupo
valprotodo <- rbind(valprosswi_largo, 
              valproei_largo,
              valprobs_largo,
              valprojo_largo,
              valprogc_largo)

```


```{r Table5, message=FALSE}
tablk <- valprotodo %>% 
  group_by(Parameter, SPRstra) %>% 
  summarise(Median = mean(SPR),
            Variance=var(SPR),
            SD = sqrt(Variance)) %>% 
  pivot_wider(names_from= SPRstra, 
              values_from = c(Median, Variance, SD),
              names_sep = " ") %>% 
  rename( "Growth scenario"="Parameter") %>% 
   mutate_if(is.numeric, round, 2)

# ReorganizaciÃ³n de las columnas
tablk_reorganizado <- tablk %>%
  mutate(
    `BS` = paste0(`Median BS`, " (", `SD BS`, ")"),
    `EI` = paste0(`Median EI`, " (", `SD EI`, ")"),
    `GS` = paste0(`Median GS`, " (", `SD GS`, ")"),
    `JOIN` = paste0(`Median JOIN`, " (", `SD JOIN`, ")"),
    `SSWI` = paste0(`Median SSWI`, " (", `SD SSWI`, ")")
  ) %>%
   select(`Growth scenario`, `BS`, `EI`, `GS`, `JOIN`, `SSWI`)  # SelecciÃ³n de columnas necesarias

# CreaciÃ³n de la tabla en LaTeX
kbl(tablk_reorganizado,
    longtable = FALSE,
    booktabs = TRUE,
    caption = "\\label{Table7}Estimates of SPR by Growth Scenario (values in parentheses represent the standard deviation)") %>%
  kable_styling(latex_options = c("scale_down", "hold_position"))

#write_csv(tablk_reorganizado, "SPR_K.csv")
```

```{r Figure10, warning=FALSE, fig.cap="Sensitivity analysis by strata about krill growth type", fig.height=3, fig.width=8}
sensproto2 <- ggplot(valprotodo %>% 
                       filter(SPR < 0.99) %>% 
                       drop_na() %>% 
                       mutate(Parameter = factor(Parameter, 
                                                 levels = c("Low",
                                                            "Med",
                                                            "High"))), 
                     aes(x = Parameter, y = SPR)) +
  geom_boxplot(aes(fill = Parameter), alpha = 0.6) +
  geom_hline(yintercept = 0.75, colour= '#006d2c', alpha=0.5, linetype="dashed") +
  geom_hline(yintercept = 0.20, colour= '#bd0026', alpha=0.5) +
  geom_jitter(aes(color = Parameter), alpha = 0.5, width = 0.1) +
  facet_wrap(~SPRstra, ncol = 5) +
  labs(y = "SPR", x = "Growth Scenario") +
  theme_minimal() +
  theme(legend.position = "none",
        panel.background = element_rect(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_fill_manual(values = c("Low" = "white", "Med" = "red", "High" = "white")) +
  scale_color_manual(values = c("Low" = "black", "Med" = "red", "High" = "black"))


sensproto2

```

## Analysis to three Subareas (48.1, 48.2 and 48.3)

Reading data

```{r, message=FALSE, warning=FALSE}
datdir <- setwd("~/DOCAS/LBSPR_Krill")
Len481 <- new("LB_lengths", 
             LB_pars=MyPars, 
             file=paste0(datdir, "/lenght481_nochina.csv"), 
             dataType="freq",
             sep=",",
             header=T)

Len482 <- new("LB_lengths", 
             LB_pars=MyPars, 
             file=paste0(datdir, "/lenght482_nochina.csv"),
             dataType="freq",
             sep=",",
             header=T)

Len483 <- new("LB_lengths", 
             LB_pars=MyPars, 
             file=paste0(datdir, "/lenght483_nochina.csv"), 
             dataType="freq",
             sep=",",
             header=T)
```

The LBSPR model is fitted by strata using the `LBSPRfit` function.

```{r, message=FALSE, warning=FALSE}
 
fit481 <- LBSPRfit(MyPars, Len481)
fit482 <- LBSPRfit(MyPars, Len482)
fit483 <- LBSPRfit(MyPars, Len483)
```

Now, to paper propose, we estimate `SPR` to all subareas (48.1, 48.2 and 48.3)

```{r}
# Get values estimated

spr481 <- as.data.frame(cbind(fit481 @Years, 
                             fit481 @SPR,
                             fit481 @Vars[,4])) 
colnames(spr481) <- c("Year","SPR", "Var")
spr481$SPRv <- rep("481", nrow(spr481))

spr482 <- as.data.frame(cbind(fit482 @Years, 
                             fit482 @SPR,
                             fit482 @Vars[,4])) 
colnames(spr482) <- c("Year","SPR", "Var")
spr482$SPRv <- rep("482", nrow(spr482))

spr483 <- as.data.frame(cbind(fit483 @Years, 
                             fit483 @SPR,
                             fit483 @Vars[,4])) 
colnames(spr483) <- c("Year","SPR", "Var")
spr483$SPRv <- rep("483", nrow(spr483))


spr48 <- rbind(spr481,
               spr482,
               spr483)

spr48 <- spr48 %>%
  mutate(SD = sqrt(Var))

spr48wide <- round(pivot_wider(spr48,
                          names_from = SPRv,
                          values_from = c(SPR, Var, SD),
                          values_fill = NA,
                          names_sep = " ",),3)

```

Figure \@ref(fig:Figure11) show the SPR trends across years to 48.1, 48.2 and 48.3, indicating the references (yellow line = 75% SPR Objective and Red line = 20% Limit SPR).

```{r Figure11, warning=FALSE, fig.cap="Krill Intrinsic Productivity (SPR) by subarea and by year", fig.height=3, fig.width=7}
spr48plot <- ggplot(spr48, aes(Year, SPR)) +
  geom_point(alpha = 0.8) +  
  geom_errorbar(aes(ymin = SPR - SD, ymax = SPR + SD), 
                width = 0.2, 
                alpha = 0.5) +
  geom_smooth(method = "lm",
              alpha=0.3,
              se=TRUE,
              col="black",
              level = 0.75)+
  geom_hline(yintercept = 0.75,
             colour = '#006d2c',
             alpha = 0.5,
             linetype = 2) +
  geom_hline(yintercept = 0.20,
             colour = '#bd0026',
             alpha = 0.5) +
  facet_wrap(. ~ SPRv, ncol = 5) +
  xlim(2001, 2021) +
  ylim(0, 0.9) +
  theme_few() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
spr48plot
```

Main outputs in Table \@ref(tab:Table6).
```{r Table6}
spr48wide_reorganizado <- spr48wide %>%
  mutate(
    `481` = ifelse(!is.na(`SPR 481`), paste0(`SPR 481`, " (", `SD 481`, ")"), NA),
    `482` = ifelse(!is.na(`SPR 482`), paste0(`SPR 482`, " (", `SD 482`, ")"), NA),
    `483` = ifelse(!is.na(`SPR 483`), paste0(`SPR 483`, " (", `SD 483`, ")"), NA)
  ) %>%
  select(Year, `481`, `482`, `483`) %>% 
  arrange(Year)

#write_csv(spr48wide_reorganizado, "SPR_all_48.csv")

kbl(spr48wide_reorganizado, 
    longtable = FALSE, 
    booktabs = TRUE, 
    caption = "\\label{Table6}Estimates of SPR by SubArea (parentheses represent the standard deviation)") %>% 
    kable_styling(latex_options = c("scale_down", "hold_position"))

```

```{r Figure12, warning=FALSE, fig.cap="Krill Intrinsic Productivity (SPR) in 48.1 by year"}
spr481plot <- ggplot(spr48 %>% 
                       filter(SPRv == "481"), aes(Year, SPR)) +
  geom_point(alpha = 0.8) +  
  geom_errorbar(aes(ymin = SPR - SD, ymax = SPR + SD), 
                width = 0.2, 
                alpha = 0.5) +
  geom_smooth(method = "lm",
              alpha=0.3,
              se=TRUE,
              col="black",
              level = 0.75)+
  geom_hline(yintercept = 0.75,
             colour = '#006d2c',
             alpha = 0.5,
             linetype = 2) +
  geom_hline(yintercept = 0.20,
             colour = '#bd0026',
             alpha = 0.5) +
  xlim(2001, 2021) +
  ylim(0, 0.9) +
  theme_few() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```


sensitivity analysis to L~inf~ to 48.1

```{r message=FALSE}
# ciclo de ajuste para 481
for (i in 55:65) {
  nombre_objeto <- paste0("MyPars_", i) 
  nombre_variable <- paste0("fit481", i) 
  objeto <- get(nombre_objeto)
  assign(nombre_variable, LBSPRfit(objeto, Len481), envir = .GlobalEnv)
}
```


```{r message=FALSE}
#Genero lo que quiero comparar BS
val481 <- as.data.frame(cbind(fit48155@Years,
  fit48155@SPR,
           fit48156@SPR,
           fit48157@SPR,
           fit48158@SPR,
           fit48159@SPR,
           fit48160@SPR,
           fit48161@SPR,
           fit48162@SPR,
           fit48163@SPR,
           fit48164@SPR,
           fit48165@SPR))
colnames(val481) <- c("Years", "Linf55","Linf56", "Linf57", "Linf58", 
                     "Linf59", "Linf60", 
                      "Linf61", "Linf62" , "Linf63",  "Linf64",
                     "Linf65")

val481_largo <- pivot_longer(val481, 
                            cols = c(2:12,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
val481_largo$SPRstra <- rep("481", nrow(val481_largo))
```



```{r Figure13, warning=FALSE, fig.cap="Sensitivity analysis to 48.1 about asymptotic length VB"}
sensprototest481 <- ggplot(val481_largo %>%
         drop_na() %>% 
           filter(SPR < 0.65),
       aes(x = SPR,
           y = Parameter)) +
  geom_boxplot(aes(fill = ifelse(Parameter == "Linf60", "red", "white")), 
               trim=TRUE,
               position=position_dodge(0.9),
               adjust = 1/5) +
  geom_vline(xintercept = 0.75,
             colour= '#006d2c',
             alpha=0.5,
             linetype=2) +
  geom_vline(xintercept = 0.20, 
             colour= '#bd0026',
             alpha=0.5) +
  geom_jitter(aes(color = ifelse(Parameter == "Linf60", "red", "black")), 
              alpha=0.4,
              height = 0,
              width = 0.1) +
  labs(x="SPR",
       y="VB Parameters tested") +
  theme_minimal() +
  theme(legend.position="top",
        axis.text.x = element_text(angle = 90, hjust = 2),
        panel.background = element_rect(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  xlim(0, 1) +
  scale_fill_identity() + 
  scale_color_identity()  
```


Now, sensitivity analysis to *k* to 48.1

```{r message=FALSE, warning=FALSE}
# ciclo de ajuste para 481
for (i in c(2,0.5,0.3)) {
  nombre_objeto <- paste0("MyPars_", i)  # Nombre del objeto S4 en cada iteraciÃ³n
  nombre_variable <- paste0("fit481", i)  # Nuevo nombre para el resultado
  
  # Obtener el objeto S4 correspondiente
  objeto <- get(nombre_objeto)
  
  # Ejecutar LBSPRfit() y asignar el resultado a una nueva variable con nombre Ãºnico
  assign(nombre_variable, LBSPRfit(objeto, Len481), envir = .GlobalEnv)
}
```



```{r}
valprofit481 <- as.data.frame(cbind(fit4810.3@Years,
                                fit4810.3@SPR,
                             fit4810.5@SPR,
                             fit4812@SPR))
colnames(valprofit481) <- c("Years", "High","Med", "Low")

valprofit481_largo <- pivot_longer(valprofit481, 
                            cols = c(2:4,), 
                            names_to = "Parameter", 
                            values_to = "SPR")
valprofit481_largo$SPRstra <- rep("481", nrow(valprofit481_largo))

```



```{r Figure14, warning=FALSE, fig.cap="Sensitivity analysis to 48.1 about k"}
senspr481 <- ggplot(valprofit481_largo %>% 
                       filter(SPR < 0.99) %>% 
                       drop_na() %>%
                       mutate(Parameter = factor(Parameter, 
                                                 levels = c("Low", 
                                                            "Med",
                                                            "High"))), 
                    aes(x = Parameter, 
                        y = SPR)) +
  geom_boxplot(aes(fill = ifelse(Parameter == "Med", "red", "white")), 
               color = "black") +  
  geom_hline(yintercept = 0.75,
             colour= '#006d2c',
             alpha=0.5,
             linetype="dashed") +
  geom_hline(yintercept = 0.20, 
             colour= '#bd0026',
             alpha=0.5) +
  geom_jitter(aes(color = ifelse(Parameter == "Med", "red", "black")), 
              alpha=0.4,
              width=0.1) +
  labs(y="SPR",
       x="Growth Scenario") +
  theme_minimal() +
  theme(legend.position="none",
        panel.background = element_rect(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_fill_identity() +  
  scale_color_identity()

```                      

Finally, join plot to 48.1 analysis; `spr481plot`, `sensprototest481`, `senspro481` (Figure \@ref(fig:Figure15)).


```{r Figure15, warning=FALSE, fig.cap="Plot to SPR in different context to 48.1 subarea", fig.height=3, fig.width=8}
ggarrange(spr481plot,
          sensprototest481,
          senspr481,
          ncol=3,
          labels = c("A", "B", "C"))
```        

\newpage

# CODE REPOSITORY

The data, codes and another documents of this exercise can be found in the following link [LBSPR-Krill](https://github.com/MauroMardones/LBSPR_Krill)


# REFERENCES
